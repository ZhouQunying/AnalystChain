# 待办：测试功能增强

> **目标**：增强 `tests/test_stage1_knowledge_retrieval.py` 测试覆盖度

---

## 新增测试项

### 1. JSON Schema 校验

**目的**：验证所有生成的JSON文件结构符合 `KnowledgeJSON` Schema

```python
def test_json_schema():
    """测试JSON结构正确性"""
    print("=" * 80)
    print("[测试] JSON Schema 校验")
    print("=" * 80)

    from analyst_chain.knowledge.schemas import KnowledgeJSON
    import json

    json_dir = STRUCTURED_JSON_DIR / Domain.MACRO_ECONOMY
    json_files = list(json_dir.glob("*.json"))

    if not json_files:
        raise FileNotFoundError(f"无JSON文件：{json_dir}")

    passed, failed = 0, 0
    for json_file in json_files:
        try:
            with open(json_file, "r", encoding="utf-8") as f:
                data = json.load(f)
            KnowledgeJSON.model_validate(data)
            print(f"  [通过] {json_file.name}")
            passed += 1
        except Exception as e:
            print(f"  [失败] {json_file.name}: {e}")
            failed += 1

    print("-" * 80)
    print(f"[结果] 通过: {passed}, 失败: {failed}")
```

---

### 2. 数据一致性校验

**目的**：验证向量库与JSON数据主题一致

```python
def test_data_consistency():
    """测试向量库与JSON数据一致性"""
    print("=" * 80)
    print("[测试] 数据一致性校验")
    print("=" * 80)

    from pathlib import Path
    import json

    # 1. 从JSON获取所有topic
    json_dir = STRUCTURED_JSON_DIR / Domain.MACRO_ECONOMY
    json_topics = set()
    for json_file in json_dir.glob("*.json"):
        with open(json_file, "r", encoding="utf-8") as f:
            data = json.load(f)
        json_topics.add(data.get("topic", ""))

    # 2. 从向量库获取所有topic（通过metadata）
    retriever = _get_retriever()
    # 查询一个通用词获取样本数据
    results = retriever.vector_search_raw("经济", k=100)
    vector_topics = set()
    for doc, _ in results:
        topic = doc.metadata.get("topic", "")
        if topic:
            vector_topics.add(topic)

    # 3. 比较
    print(f"JSON 主题数: {len(json_topics)}")
    print(f"向量库主题数: {len(vector_topics)}")

    only_in_json = json_topics - vector_topics
    only_in_vector = vector_topics - json_topics

    if only_in_json:
        print(f"\n[警告] 仅在JSON中: {only_in_json}")
    if only_in_vector:
        print(f"\n[警告] 仅在向量库中: {only_in_vector}")

    if not only_in_json and not only_in_vector:
        print("\n[通过] 数据一致")
    else:
        print("\n[失败] 数据不一致")
```

---

### 3. main函数更新

```python
def main():
    """运行所有测试"""
    # ... 现有测试 ...

    # 测试5: JSON Schema 校验
    test_json_schema()

    # 测试6: 数据一致性校验
    test_data_consistency()
```

---

## 前置依赖

| 依赖 | 说明 |
|------|------|
| `KnowledgeJSON` | 从 `analyst_chain.knowledge.schemas` 导入 |
| `Domain` | 从 `analyst_chain.knowledge.constants` 导入 |
| `STRUCTURED_JSON_DIR` | 从 `analyst_chain.knowledge.constants` 导入 |
| `vector_search_raw` | 需要 `KnowledgeRetriever` 增加返回原始结果的方法（如不存在需新增） |

---

## 状态

- [ ] 实现 `test_json_schema`
- [ ] 实现 `test_data_consistency`
- [ ] 更新 `main` 函数
- [ ] 验证测试通过

